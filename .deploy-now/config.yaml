# IONOS Deploy Now Configuration for Laravel
# Based on: https://github.com/ionos-deploy-now/laravel-starter/blob/main/.deploy-now/config.yaml
# https://docs.ionos.space/docs/deployment-configuration/

version: 1.0
deploy:
  # comment in one of the following lines to force the use of the recurring or bootstrap configuration
  #  force: recurring
  #  force: bootstrap

  # configure the initial deployment of each branch
  bootstrap:
    # directories that are not overwritten or removed by the next deployment
    excludes:
      - .git
      - .github
      - .gitignore
      - .env.example
      - tests
      - node_modules
      - frontend
      - backend
      - deploy
      - access.log.current
      # the following files are generated during composer action and are not necessary
      - DOCKER_ENV
      - docker_tag
      - output.log
      - Dockerfile-php-build
      - .template-renderer-data

    # commands that are executed on the runtime after new files are copied
    post-deployment-remote-commands:
      # set right file permissions for Laravel
      - find $(pwd) -type f -not -path "$(pwd)/logs/*" -exec chmod 664 {} \;
      - find $(pwd) -type d -not -name "logs" -exec chmod 775 {} \;
      - chmod -R o+w storage bootstrap/cache
      # NOTE: PHP commands disabled because project is configured as "Starter Pack"
      # Starter Pack does not support PHP runtime commands
      # To enable PHP commands, contact IONOS Support to change package type to "PHP Package"
      # Or manually run these commands via SSH after deployment:
      # - php artisan migrate --force
      # - php artisan optimize:clear
      # - php artisan optimize

  # configure all following deployments of each branch
  recurring:
    # directories that are not overwritten or removed by the next deployment
    excludes:
      - .git
      - .github
      - .gitignore
      - .env.example
      - tests
      - node_modules
      - frontend
      - backend
      - deploy
      - access.log.current
      - DOCKER_ENV
      - docker_tag
      - output.log
      - Dockerfile-php-build
      - .template-renderer-data
      # the storage folder shouldn't be synced after first deployment, because there
      # are files inside from running the Laravel app (e.g. database)
      - storage
      - .env
      - bootstrap/cache

    # commands that are executed on the runtime before new files are copied
    pre-deployment-remote-commands:
      # NOTE: PHP commands disabled because project is configured as "Starter Pack"
      # If you have SSH access, you can manually run: php artisan down
      # - php8.2-cli artisan down || php8.1-cli artisan down || true

    # commands that are executed on the runtime after new files are copied
    post-deployment-remote-commands:
      - find $(pwd) -type f -not -path "$(pwd)/logs/*" -exec chmod 664 {} \;
      - find $(pwd) -type d -not -name "logs" -exec chmod 775 {} \;
      - chmod -R o+w storage bootstrap/cache
      # NOTE: PHP commands disabled because project is configured as "Starter Pack"
      # Starter Pack does not support PHP runtime commands
      # To enable PHP commands, contact IONOS Support to change package type to "PHP Package"
      # Or manually run these commands via SSH after deployment:
      # - php artisan migrate --force
      # - php artisan optimize:clear
      # - php artisan optimize
