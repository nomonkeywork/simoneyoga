name: Deploy to IONOS

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build React app
        working-directory: frontend
        run: npm run build

      - name: Prepare deploy folder
        run: |
          # Clean deploy folder (keep index.php and .htaccess)
          rm -rf deploy/assets deploy/api deploy/config
          mkdir -p deploy/assets deploy/api deploy/config
          
          # Copy React build
          cp -r frontend/dist/* deploy/assets/
          
          # Copy PHP backend (only production files)
          cp -r backend/api/*.php deploy/api/
          cp -r backend/config/*.php deploy/config/
          cp backend/.htaccess deploy/api/.htaccess 2>/dev/null || true
          
          # Ensure index.php exists
          if [ ! -f deploy/index.php ]; then
            echo "<?php readfile(__DIR__ . '/assets/index.html');" > deploy/index.php
          fi
          
          # .htaccess should already exist with correct config, but verify
          if [ ! -f deploy/.htaccess ]; then
            echo "Warning: deploy/.htaccess not found, creating minimal version"
            cat > deploy/.htaccess << 'EOF'
          RewriteEngine On
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteCond %{REQUEST_URI} !^/api/
          RewriteRule ^ index.php [L]
          EOF
          fi

      - name: Deploy to IONOS via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ftp.simoneyoga.de
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /htdocs/
          local-dir: ./deploy/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/.use-mock
            **/README*.md
            **/test-*.php
            **/test-*.sh
            **/start-*.sh
            **/*.backup

