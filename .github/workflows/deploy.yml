name: Deploy to IONOS

# COMPLETELY DISABLED - Using IONOS Deploy Now instead
# See .github/workflows/simoneyoga-orchestration.yaml
# This workflow is kept for reference only (old React+PHP architecture)
# 
# To fully remove: Delete this file or uncomment the 'on:' section below
# To re-enable: Uncomment the 'on:' section and restore original triggers

# on:
#   workflow_dispatch:  # Fully disabled - no triggers
#   # push:
#   #   branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build React app
        working-directory: frontend
        run: npm run build

      - name: Prepare deploy folder
        run: |
          # Clean deploy folder (keep index.php and .htaccess)
          rm -rf deploy/assets deploy/api deploy/config
          mkdir -p deploy/assets deploy/api deploy/config
          
          # Copy React build
          cp -r frontend/dist/* deploy/assets/
          
          # Copy PHP backend (only production files)
          cp -r backend/api/*.php deploy/api/
          cp -r backend/config/*.php deploy/config/
          cp backend/.htaccess deploy/api/.htaccess 2>/dev/null || true
          
          # Ensure index.php exists
          if [ ! -f deploy/index.php ]; then
            echo "<?php readfile(__DIR__ . '/assets/index.html');" > deploy/index.php
          fi
          
          # .htaccess should already exist with correct config, but verify
          if [ ! -f deploy/.htaccess ]; then
            echo "Warning: deploy/.htaccess not found, creating minimal version"
            cat > deploy/.htaccess << 'EOF'
          RewriteEngine On
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteCond %{REQUEST_URI} !^/api/
          RewriteRule ^ index.php [L]
          EOF
          fi

      - name: Deploy to IONOS via SFTP
        run: |
          sudo apt-get update && sudo apt-get install -y lftp
          lftp -c "
            set sftp:auto-confirm yes
            set sftp:connect-program 'ssh -a -x -o StrictHostKeyChecking=no'
            open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} -p 22 sftp://access877587871.webspace-data.io
            cd /htdocs/
            mirror -R --delete --verbose --exclude-glob='.git*' --exclude-glob='node_modules/**' --exclude-glob='.DS_Store' --exclude-glob='.use-mock' --exclude-glob='README*.md' --exclude-glob='test-*' --exclude-glob='start-*' --exclude-glob='*.backup' ./deploy/ /htdocs/
            quit
          "

